# Kodegjennomgang: ekomadmin

**Dato:** 2026-01-18
**Scope:** Hele kodebasen
**Reviewer:** Kodeagent

---

## Oppsummering

| Prioritet | Antall |
|-----------|--------|
| üî¥ Kritisk | 0 |
| üü† H√∏y | 2 |
| üü° Medium | 4 |
| üü¢ Lav | 3 |

**Overordnet vurdering:** Kodebasen er velstrukturert og f√∏lger moderne Next.js-patterns. Server Actions har konsistent feilh√•ndtering og Zod-validering. Ingen kritiske sikkerhetsproblemer funnet.

---

## Funn

### üü† H√∏y prioritet

#### 1. Manglende autentisering i Server Actions
**Fil:** `src/app/actions/*.ts`
**Beskrivelse:** Server Actions sjekker ikke at brukeren er autentisert f√∏r de utf√∏rer database-operasjoner. Selv om proxy.ts beskytter routes, kan Server Actions potensielt kalles direkte.

**Anbefaling:** Legg til auth-sjekk i hver Server Action:
```typescript
import { auth } from "@/lib/auth";

export async function createTilbyder(input: TilbyderCreateInput) {
  const session = await auth();
  if (!session) {
    return { success: false, error: "Ikke autentisert" };
  }
  // ... resten av koden
}
```

**Risiko:** Uautorisert tilgang til database-mutasjoner hvis noen kjenner action-navnene.

---

#### 2. Duplikatkode i gruppering.ts
**Fil:** `src/app/actions/gruppering.ts`
**Beskrivelse:** Samme logikk for √• hente fusjoner og tilbyder-info er duplisert i flere funksjoner (`listGrupperinger`, `getGrupperingerByGruppe`, `listTilbydereUtenGruppe`, `listGrupperingerByGruppe`).

**Anbefaling:** Ekstraher felles logikk til hjelpefunksjoner:
```typescript
async function getTilbyderMap(ids: number[]) { ... }
async function getFusjonerMap() { ... }
```

**Risiko:** Vedlikeholdsproblemer, inkonsistens ved endringer.

---

### üü° Medium prioritet

#### 3. N+1-liknende m√∏nster i fusjoner-henting
**Fil:** `src/app/actions/tilbydere.ts:129-178`
**Beskrivelse:** `getFusjonerForTilbyder` gj√∏r 3 separate database-kall. Dette er OK for enkeltsider, men kan bli et problem ved masseoppdateringer.

**N√•v√¶rende kode:**
```typescript
const [fusjonerFra, fusjonerTil] = await Promise.all([...]);
const tilbydere = await prisma.tilbydere.findMany({...});
```

**Anbefaling:** Vurder √• kombinere til f√¶rre queries hvis ytelse blir et problem.

---

#### 4. Manglende input-validering i delete-funksjoner
**Fil:** `src/app/actions/tilbydere.ts:247-258`
**Beskrivelse:** `deleteTilbyder` tar `id: number` direkte uten Zod-validering. Selv om TypeScript hjelper, kan runtime-verdier v√¶re feil.

**Anbefaling:** Legg til enkel Zod-validering for konsistens:
```typescript
const deleteSchema = z.object({ id: z.number().int().positive() });
```

---

#### 5. Excel-eksport p√• klient-side med all data
**Fil:** `src/app/(dashboard)/kontakter/export-kontakter-button.tsx`
**Beskrivelse:** Hele kontaktlisten sendes til klienten f√∏r Excel-generering. For store datasett kan dette p√•virke ytelse.

**Anbefaling:** Vurder server-side Excel-generering for store datasett, eller implementer paginert eksport.

---

#### 6. Hardkodet "Ukjent" fallback
**Filer:** Flere steder i actions/
**Beskrivelse:** Teksten `Ukjent (${id})` er hardkodet flere steder.

**Anbefaling:** Definer som konstant for konsistens:
```typescript
const UNKNOWN_TILBYDER = (id: number) => `Ukjent (${id})`;
```

---

### üü¢ Lav prioritet

#### 7. ESLint-disable kommentar
**Fil:** `src/components/data-table.tsx:108-109`
**Beskrivelse:** `eslint-disable-next-line react-hooks/exhaustive-deps` brukes for `getFilteredData` callback.

**N√•v√¶rende kode:**
```typescript
// eslint-disable-next-line react-hooks/exhaustive-deps
[table.getFilteredRowModel().rows]
```

**Anbefaling:** Vurder om dette kan l√∏ses uten disable, f.eks. med `useMemo` p√• rows.

---

#### 8. Manglende TypeScript strict mode for null-checks
**Fil:** Diverse steder
**Beskrivelse:** Noen steder brukes `kontakt.aktiv === false` istedenfor √• h√•ndtere at `aktiv` kan v√¶re `null`.

**Eksempel:** `tilbydere/[id]/page.tsx:145`
```typescript
{kontakt.aktiv === false && (...)}  // null vises ikke som inaktiv
```

**Anbefaling:** Vurder om `aktiv === false` eller `!aktiv && aktiv !== null` er √∏nsket oppf√∏rsel.

---

#### 9. Ingen rate limiting
**Beskrivelse:** Server Actions har ingen rate limiting. For et internt admin-verkt√∏y er dette sannsynligvis OK, men kan vurderes for fremtiden.

---

## Positive observasjoner

‚úÖ **Konsistent arkitektur:** Server Actions med ActionResult-pattern gir god feilh√•ndtering

‚úÖ **Zod-validering:** All brukerinput valideres med Zod-skjemaer

‚úÖ **TypeScript:** Streng typing med gode type-definisjoner

‚úÖ **Prisma-singleton:** Korrekt implementert for √• unng√• connection pooling-problemer

‚úÖ **Feilh√•ndtering:** `withErrorHandling` wrapper gir konsistent Prisma-feilh√•ndtering

‚úÖ **Auth allowlist:** Email allowlist gir god tilgangskontroll

‚úÖ **Dev login:** Separat auth-provider for testing er godt implementert

‚úÖ **Gjenbrukbare komponenter:** DataTable, skjemaer og dialogs er modul√¶re

‚úÖ **Loading states:** Skeleton-komponenter og loading.tsx per route

‚úÖ **Mobil-st√∏tte:** Responsive design med egen mobilmeny

---

## Anbefalte tiltak

### Umiddelbart (f√∏r neste release)
1. Legg til auth-sjekk i alle Server Actions

### Kort sikt
2. Refaktorer duplikatkode i gruppering.ts
3. Standardiser delete-validering med Zod

### Langsiktig
4. Vurder server-side Excel-eksport
5. Legg til automatiske tester
6. Implementer rate limiting

---

## Konklusjon

Kodebasen er av god kvalitet med moderne patterns og god struktur. Det viktigste funnet er manglende auth-sjekk i Server Actions, som b√∏r fikses. Resten er forbedringer for vedlikeholdbarhet og fremtidig skalering.
